---
- name: Initial setup
  hosts: setupserver

  tasks:
    - name: setting hostname
      hostname:
        name: '{{ nodename }}'
      register: task_result

    - name: Reboot immediately
      shell: "sleep 5 && reboot"
      async: 1
      poll: 0
      when: task_result is changed

    - name: Wait for the reboot to complete
      wait_for_connection:
        connect_timeout: 20
        sleep: 5
        delay: 5
        timeout: 300   
      when: task_result is changed
      
    - name: Install gluster software
      package:
        name: [aptitude, docker.io, parted, glusterfs-server, glusterfs-client, attr]
        state: present

    - name: Upgrade all packages to the latest version
      package:
        name: "*"
        state: latest
      async: 900
      poll: 20

    - name: Reboot immediately
      shell: "sleep 5 && reboot"
      async: 1
      poll: 0
